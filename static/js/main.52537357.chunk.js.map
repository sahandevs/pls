{"version":3,"sources":["data/PLSDB.ts","Utils.tsx","Components/Pages/ExchangePage.tsx","hooks/useIsSmallScreen.ts","Components/Pages/SetupCurrencies.tsx","Components/Pages/SetupExchangeRates.tsx","data/SystemsDB.ts","Components/Pages/Systems/Canvas.tsx","Components/Pages/Systems/BorderTrigger.tsx","Components/Pages/Systems/CanvasNode.tsx","Components/Pages/Systems/GoalView.tsx","Components/Pages/Systems/SystemView.tsx","Components/Pages/Systems/ConnectionsView.tsx","Components/Pages/Systems/SystemsPage.tsx","Components/App.tsx","serviceWorker.ts","index.tsx"],"names":["PLSDBContext","React","createContext","firebase","window","usePLSDBContext","result","useContext","Error","PLSDatabase","currencies","BehaviorSubject","exchangeRates","bank","dbRef","combineLatest","this","pipe","skip","distinct","debounceTime","subscribe","next","save","currency","newValue","value","find","x","id","Object","assign","push","map","bankOf","v","Math","max","exchangeRate","canExchange","take","newBank","from","to","rate","filter","uid","firestore","enablePersistence","then","console","log","catch","err","error","database","ref","on","s","db","dbs","old_db","new_db","version","name_to_id","c","newUuid","name","icon","isSource","unit","e","keys","key","migrateDb","JSON","parse","val","data","stringify","localStorage","setItem","floor","getItem","set","URL","createObjectURL","Blob","split","pop","useObservable","obs","defaultValue","useState","setValue","useEffect","sub","unsubscribe","getOrAskUser","prompt","ExchangeButtonBase","onDone","innerRef","MenuItem","disabled","onClick","exchange","getCurrency","ExchangeButton","forwardRef","props","ExchangeItem","getExchangeRates","currentValue","anchorEl","setAnchorEl","handleClose","Card","variant","style","margin","Box","padding","display","flexDirection","Typography","dangerouslySetInnerHTML","__html","toLowerCase","replace","Button","event","currentTarget","aria-controls","aria-haspopup","Menu","keepMounted","open","onClose","item","addToBank","SpendItem","canSpend1","canSpend","length","ExchangePage","getCurrencies","search","setSearch","eventHandler","slice","document","addEventListener","removeEventListener","isInFilter","match","alignItems","flexWrap","justifyContent","Divider","useIsSmallScreen","useMediaQuery","CurrencyItem","isNew","setName","setIcon","setIsSource","setUnit","isSmallScreen","isEdited","content","Icon","TextField","label","onChange","target","Checkbox","checked","addOrUpdateCurrency","removeCurrency","SetupCurrencies","i","Item","setFrom","setTo","toString","rateValue","setRateValue","Number","isValid","isNaN","FormControl","InputLabel","Select","labelId","d","marginX","inputMode","addOrUpdateExchangeRate","removeExchangeRate","SetupExchangeRates","rates","PLACEHOLDER_GOAL","bounds","top","height","left","width","labels","SystemsDBContext","useSystemsDBContext","toKey","obj","SystemsDB","_forceUpdate","goals","connections","systems","config","zoomLevel","cameraPosition","y","updated","alert","goal","_system","sysSubject","throttleTime","system","a","b","flatMap","updateFromDiff","old","_new","indexedOldTargets","targetsDiff","_olds","news","newAdded","existed","outer","deleted","includes","findDiff","targetUpdateResult","forEach","_subject","useStyles","makeStyles","rootContainer","innerContainer","position","calculateTransform","Canvas","containerRef","useRef","positionRef","styles","size","setSize","isHoldingMouseMiddleButton","keyCode","isDown","setIsDown","onMouseDown","button","onMouseUp","useIsHoldinMouseKey","setScale","useMemo","updateDbConfig","useCallback","updateInnerRefStyle","animate","current","innerText","toPrecision","ANIMATION","setAttribute","onKeyUp","_doUpdateScale","onMouseWheel","deltaY","useLayoutEffect","body","cursor","onMouseMove","movementX","movementY","calculateAndUpdateSize","innerHeight","getBoundingClientRect","innerWidth","fromEvent","className","overflow","children","bottom","right","opacity","BorderTrigger","rowStyle","cornerStyle","borderWidth","hLineStyle","flex","vLineStyle","onMouseEnter","onTL","undefined","state","onMouseLeave","onT","onTR","onL","onR","onBL","onB","onBR","CanvasNode","isHoldingBorder","updateManager","initial","forceRefresh","setVal","useForceUpdate","lastBorderState","update","calculate","filteredResult","setTimeout","sendUpdate","updates","scale","handle","onDrag","positionOffset","offsetPosition","GoalView","isSelected","selectedGoal","updateGoalWithKey","goalKey","getGoalInitialValue","tap","_pos","toFixed","_bounds","elevation","userSelect","confirm","deleteGoal","fontSize","alignSelf","newName","Chip","labelValue","color","SystemView","systemGoals","getSystemGoals","systemKey","updateSystemWithKey","getSystemInitialValue","systemNameBorder","borderColor","borderStyle","borderRadius","borderTopLeftRadius","pointerEvents","deleteSystem","paddingLeft","paddingRight","borderLeft","borderTop","borderRight","ConnectionsView","getConnectionsWithKeys","stroke","fill","strokeWidth","connection","ConnectionView","fromGoalKey","toGoalKey","getGoalWithKey","getBoxToBoxArrow","bow","sx","sy","cx","cy","ex","ey","endAngleAsDegrees","PI","r","deleteConnection","points","transform","SystemsPage","getZoomLevel","getGoalsWithKey","getSystemsWithKey","isInCreateConnectionMode","setIsInCreateConnectionMode","selectedFirstGoal","setSelectedFirstGoal","createConnection","Tooltip","title","IconButton","goalName","createGoal","systemName","createSystem","App","page","setPage","plsDb","pls","CreateOrGetDefaultPLSDatabase","systemsDb","username","password","didSetupDb","localUID","setupIfNeeded","loadFromFirebase","auth","signInWithEmailAndPassword","user","message","location","reload","Provider","CssBaseline","AppBar","Tabs","_","centered","Tab","marginTop","minWidth","Boolean","hostname","ReactDOM","render","getElementById","navigator","serviceWorker","ready","registration","unregister"],"mappings":"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","file":"static/js/main.52537357.chunk.js","sourcesContent":["import { Observable, BehaviorSubject, combineLatest } from \"rxjs\";\nimport { map, take, skip, distinct, debounceTime } from \"rxjs/operators\";\nimport React from \"react\";\n\nexport const PLSDBContext = React.createContext<PLSDatabase | null>(null);\nconst firebase = (window as any).firebase;\nexport function usePLSDBContext(): PLSDatabase {\n  const result = React.useContext(PLSDBContext);\n  if (result == null)\n    throw new Error(\"useDBContext used outside of the context\");\n  return result;\n}\n\ntype Id = string;\n\nexport type Currency = {\n  id: Id;\n  name: string;\n  unit: string;\n  isSource: boolean;\n  icon: string;\n};\n\nexport type ExchangeRate = {\n  from: Id;\n  to: Id;\n  rate: number;\n};\n\nexport type Bank = { [key: string]: number };\n\ntype V1DB = {\n  currencies: {\n    name: string;\n    unit: string;\n    isTime: boolean;\n    isSource: boolean;\n    icon: string;\n    description: string;\n  }[];\n  exchangeRates: {\n    from: Currency;\n    to: Currency;\n    rate: number;\n  }[];\n  bank: { [key: string]: number };\n};\n\ntype DB = {\n  currencies: Currency[];\n  exchangeRates: ExchangeRate[];\n  bank: Bank;\n  version: \"2\";\n};\n\ntype DBs = V1DB | DB;\n\nexport class PLSDatabase {\n  constructor() {\n    combineLatest([\n      this.bank.pipe(skip(1), distinct()),\n      this.exchangeRates.pipe(skip(1), distinct()),\n      this.currencies.pipe(skip(1), distinct()),\n    ])\n      .pipe(debounceTime(1000))\n      .subscribe({ next: () => this.save() });\n  }\n\n  private currencies = new BehaviorSubject<Currency[]>([]);\n  private exchangeRates = new BehaviorSubject<ExchangeRate[]>([]);\n  private bank = new BehaviorSubject<Bank>({});\n\n  addOrUpdateCurrency(currency: Currency) {\n    const newValue = [...this.currencies.value];\n    const result = newValue.find((x) => x.id === currency.id);\n    if (result != null) {\n      Object.assign(result, currency);\n    } else {\n      newValue.push(currency);\n    }\n    this.currencies.next(newValue);\n  }\n\n  get version(): DB[\"version\"] {\n    return \"2\";\n  }\n\n  getCurrency(id: Id): Currency | undefined {\n    return this.currencies.value.find((x) => x.id === id);\n  }\n\n  bankOf(currency: Id): Observable<number> {\n    return this.bank.pipe(\n      map((bank) => {\n        return bank[currency] ?? 0;\n      })\n    );\n  }\n\n  canSpend(currency: Currency, value: number): Observable<boolean> {\n    return this.bankOf(currency.id).pipe(map((v) => v - value >= 0));\n  }\n\n  addToBank(currency: Currency, value: number) {\n    this.bank.next({\n      ...this.bank.value,\n      [currency.id]: Math.max(\n        0,\n        (this.bank.value[currency.id] ?? 0) + value\n      ),\n    });\n  }\n\n  exchange(exchangeRate: ExchangeRate, value: number) {\n    this.canExchange(exchangeRate, value)\n      .pipe(take(1))\n      .subscribe({\n        next: (canExchange) => {\n          if (canExchange) {\n            const newBank = { ...this.bank.value };\n            if (newBank[exchangeRate.from] == null) {\n              newBank[exchangeRate.from] = 0;\n            }\n            newBank[exchangeRate.from] -= value;\n            if (newBank[exchangeRate.to] == null) {\n              newBank[exchangeRate.to] = 0;\n            }\n            newBank[exchangeRate.to] += value * exchangeRate.rate;\n            this.bank.next(newBank);\n          }\n        },\n      });\n  }\n\n  canExchange(exchangeRate: ExchangeRate, value: number): Observable<boolean> {\n    return this.bankOf(exchangeRate.from).pipe(map((v) => v >= value));\n  }\n\n  removeCurrency(currency: Currency) {\n    this.currencies.next(\n      this.currencies.value.filter((x) => x.id !== currency.id)\n    );\n  }\n\n  addOrUpdateExchangeRate(rate: ExchangeRate) {\n    const newValue = [...this.exchangeRates.value];\n    const result = newValue.find(\n      (x) => x.from === rate.from && x.to === rate.to\n    );\n    if (result != null) {\n      Object.assign(result, rate);\n    } else {\n      newValue.push(rate);\n    }\n    this.exchangeRates.next(newValue);\n  }\n\n  removeExchangeRate(rate: ExchangeRate) {\n    this.exchangeRates.next(\n      this.exchangeRates.value.filter(\n        (x) => x.from !== rate.from || x.to !== rate.to\n      )\n    );\n  }\n\n  getCurrencies(): Observable<Currency[]> {\n    return this.currencies;\n  }\n\n  getExchangeRates(): Observable<ExchangeRate[]> {\n    return this.exchangeRates;\n  }\n\n  dbRef: any;\n\n  loadFromFirebase(uid: string) {\n    firebase\n      .firestore()\n      .enablePersistence()\n      .then((x) => console.log(\"OK enablePersistence\", x))\n      .catch((err) => console.error(\"NOK enablePersistence\", err));\n    this.dbRef = firebase.database().ref(`sync_data/${uid}`);\n    console.log(this.dbRef);\n    this.dbRef.on(\"value\", (s: any) => {\n      const result = JSON.parse(s.val() ?? \"{}\") as DBs;\n      const db = migrateDb(result);\n      this.currencies.next(db.currencies);\n      this.exchangeRates.next(db.exchangeRates);\n      this.bank.next(db.bank);\n      console.log(\"Updating\");\n    });\n  }\n\n  backup() {\n    const result = {\n      currencies: this.currencies.value,\n      exchangeRates: this.exchangeRates.value,\n      bank: this.bank.value,\n    };\n    let data = JSON.stringify(result);\n    localStorage.setItem(\"__backup_PLSDB\", data);\n    console.log(\"Backup\", data);\n  }\n\n  floorAllBanks() {\n    let bank: Bank = JSON.parse(JSON.stringify(this.bank.value));\n    for (const key of Object.keys(bank)) {\n      bank[key] = Math.floor(bank[key]);\n    }\n    this.bank.next(bank);\n  }\n\n  restoreBackup() {\n    let data = localStorage.getItem(\"__backup_PLSDB\");\n    console.log(\"Restoring backup\");\n    this.dbRef.set(data);\n  }\n\n  save() {\n    const result = {\n      currencies: this.currencies.value,\n      exchangeRates: this.exchangeRates.value,\n      bank: this.bank.value,\n      version: \"2\"\n    };\n    this.dbRef.set(JSON.stringify(result));\n    console.log(\"Saving\");\n  }\n}\n\nexport function CreateOrGetDefaultPLSDatabase(): PLSDatabase {\n  const db = new PLSDatabase();\n  (window as any).pls = db;\n  return db;\n}\n\nexport function newUuid(): string {\n  return window.URL.createObjectURL(new Blob([])).split(\"/\").pop()!;\n}\n\nfunction migrateDb(dbs: DBs): DB {\n  if (dbs[\"version\"] != null && dbs[\"version\"] === \"2\") {\n    return dbs as DB;\n  }\n  const old_db = dbs as V1DB;\n  const new_db: DB = {\n    bank: {},\n    currencies: [],\n    exchangeRates: [],\n    version: \"2\",\n  };\n  const name_to_id: { [name: string]: string } = {};\n  for (const c of old_db.currencies) {\n    const id = newUuid();\n    name_to_id[c.name] = id;\n    new_db.currencies.push({\n      icon: c.icon,\n      id: id,\n      isSource: c.isSource,\n      name: c.name,\n      unit: c.unit,\n    });\n  }\n\n  for (const e of old_db.exchangeRates) {\n    new_db.exchangeRates.push({\n      from: name_to_id[e.from.name],\n      to: name_to_id[e.to.name],\n      rate: e.rate,\n    });\n  }\n\n  for (const key of Object.keys(old_db.bank)) {\n    new_db.bank[name_to_id[key]] = old_db.bank[key];\n  }\n\n  return new_db;\n}\n","import { Observable } from \"rxjs\";\nimport React from \"react\";\nexport function useObservable<T>(\n  obs: Observable<T> | (() => Observable<T>),\n  defaultValue: T\n): T {\n  const [value, setValue] = React.useState(defaultValue);\n  React.useEffect(() => {\n    const _obs = typeof obs === \"function\" ? obs() : obs;\n    const sub = _obs.subscribe({\n      next: (v) => {\n        setValue(v);\n      },\n    });\n    return () => sub.unsubscribe();\n    // TODO: it doens't support when obs changes\n    // eslint-disable-next-line\n  }, []);\n  return value;\n}\n\nexport function getOrAskUser(key: string): string {\n  let value = localStorage.getItem(key);\n  if (value == null) {\n    value = prompt(key) ?? \"\";\n    localStorage.setItem(key, value);\n  }\n  return value;\n}\n\nexport function useForceUpdate(): VoidFunction {\n  const [, setVal] = React.useState(0);\n  const cb = React.useCallback(() => setVal((c) => c + 1), []);\n  return cb;\n}\n","import React from \"react\";\nimport {\n  Box,\n  Typography,\n  Divider,\n  Button,\n  Card,\n  MenuItem,\n  Menu,\n} from \"@material-ui/core\";\nimport { usePLSDBContext, Currency, ExchangeRate } from \"../../data/PLSDB\";\nimport { useObservable } from \"../../Utils\";\ntype ExchangeButtonBaseProps = {\n  exchangeRate: ExchangeRate;\n  value: number;\n  onDone: () => void;\n  innerRef: any;\n};\nfunction ExchangeButtonBase({\n  exchangeRate,\n  value,\n  onDone,\n  innerRef,\n}: ExchangeButtonBaseProps) {\n  const db = usePLSDBContext();\n  const canExchange = useObservable(db.canExchange(exchangeRate, value), false);\n  return (\n    <MenuItem\n      disabled={!canExchange}\n      innerRef={innerRef}\n      onClick={() => {\n        db.exchange(exchangeRate, value);\n        onDone();\n      }}\n    >{`1 ${db.getCurrency(exchangeRate.from)!.unit} of ${\n      db.getCurrency(exchangeRate.from)!.name\n    } to ${value * exchangeRate.rate} ${\n      db.getCurrency(exchangeRate.to)!.unit\n    } of ${db.getCurrency(exchangeRate.to)!.name}`}</MenuItem>\n  );\n}\n\nconst ExchangeButton = React.forwardRef(\n  (props: Omit<ExchangeButtonBaseProps, \"innerRef\">, ref) => (\n    <ExchangeButtonBase {...props} innerRef={ref} />\n  )\n);\n\nfunction ExchangeItem({\n  currency,\n  filter,\n}: {\n  currency: Currency;\n  filter: string;\n}) {\n  const db = usePLSDBContext();\n  const exchangeRates = useObservable(db.getExchangeRates(), []);\n  const currentValue = useObservable(db.bankOf(currency.id), 0);\n  const [anchorEl, setAnchorEl] = React.useState<Element | null>(null);\n  const handleClose = () => {\n    setAnchorEl(null);\n  };\n\n  return (\n    <Card variant={\"outlined\"} style={{ margin: 3 }}>\n      <Box padding={2} display={\"flex\"} flexDirection={\"column\"}>\n        <Typography>\n          {`${currentValue} ${currency.unit} of `}\n          <span\n            dangerouslySetInnerHTML={{\n              __html: currency.name\n                .toLowerCase()\n                .replace(\n                  filter,\n                  `<span style=\"background-color:yellow\">${filter}</span>`\n                ),\n            }}\n          ></span>\n        </Typography>\n        <Button\n          onClick={(event) => setAnchorEl(event.currentTarget)}\n          aria-controls=\"menu\"\n          aria-haspopup=\"true\"\n        >\n          {\"Exchange\"}\n        </Button>\n        <Menu\n          id=\"menu\"\n          anchorEl={anchorEl}\n          keepMounted\n          open={anchorEl != null}\n          onClose={handleClose}\n        >\n          {exchangeRates\n            .filter((x) => x.from === currency.id)\n            .map((item) => (\n              <ExchangeButton\n                key={item.from + \"_\" + item.to}\n                exchangeRate={item}\n                value={1}\n                onDone={handleClose}\n              />\n            ))}\n        </Menu>\n        <Box display={\"flex\"} flexDirection={\"row\"}>\n          <Button onClick={(event) => db.addToBank(currency, 1)}>{\"+1\"}</Button>\n          <Button onClick={(event) => db.addToBank(currency, -1)}>\n            {\"-1\"}\n          </Button>\n        </Box>\n      </Box>\n    </Card>\n  );\n}\n\nfunction SpendItem({\n  currency,\n  filter,\n}: {\n  currency: Currency;\n  filter: string;\n}) {\n  const db = usePLSDBContext();\n  const currentValue = useObservable(db.bankOf(currency.id), 0);\n  const canSpend1 = useObservable(db.canSpend(currency, 1), false);\n  const exchangeRates = useObservable(db.getExchangeRates(), []).filter(\n    (x) => x.from === currency.id\n  );\n  const [anchorEl, setAnchorEl] = React.useState<Element | null>(null);\n  const handleClose = () => {\n    setAnchorEl(null);\n  };\n  return (\n    <Card variant={\"outlined\"} style={{ margin: 3 }}>\n      <Box padding={2} display={\"flex\"} flexDirection={\"column\"}>\n        <Typography>\n          {`${currentValue} ${currency.unit} of `}\n          <span\n            dangerouslySetInnerHTML={{\n              __html: currency.name\n                .toLowerCase()\n                .replace(\n                  filter,\n                  `<span style=\"background-color:yellow\">${filter}</span>`\n                ),\n            }}\n          ></span>\n        </Typography>\n        {exchangeRates.length > 0 && (\n          <>\n            <Button\n              onClick={(event) => setAnchorEl(event.currentTarget)}\n              aria-controls=\"menu\"\n              aria-haspopup=\"true\"\n            >\n              {\"Exchange\"}\n            </Button>\n            <Menu\n              id=\"menu\"\n              anchorEl={anchorEl}\n              keepMounted\n              open={anchorEl != null}\n              onClose={handleClose}\n            >\n              {exchangeRates\n                .filter((x) => x.from === currency.id)\n                .map((item) => (\n                  <ExchangeButton\n                    key={item.from + \"_\" + item.to}\n                    exchangeRate={item}\n                    value={1}\n                    onDone={handleClose}\n                  />\n                ))}\n            </Menu>\n          </>\n        )}\n        <Button\n          disabled={!canSpend1}\n          onClick={() => db.addToBank(currency, -1)}\n        >{`Spend 1 ${currency.unit}`}</Button>\n      </Box>\n    </Card>\n  );\n}\n\nexport function ExchangePage() {\n  const db = usePLSDBContext();\n  const currencies = useObservable(db.getCurrencies(), []);\n  const [search, setSearch] = React.useState(\"\");\n  React.useEffect(() => {\n    const eventHandler = (e: KeyboardEvent) => {\n      switch (e.key) {\n        case \"Escape\":\n          setSearch(\"\");\n          break;\n        case \"Backspace\":\n          setSearch((x) => x.slice(0, -1));\n          break;\n        default:\n          if (e.key.length === 1) setSearch((x) => x + e.key);\n          break;\n      }\n    };\n    document.addEventListener(\"keydown\", eventHandler);\n    return () => document.removeEventListener(\"keydown\", eventHandler);\n  }, [setSearch]);\n\n  const isInFilter = (x) => x.name.toLowerCase().match(search.toLowerCase());\n\n  return (\n    <Box display={\"flex\"} flexDirection={\"column\"} alignItems={\"center\"}>\n      <Typography variant={\"h5\"}>{\"Exchange\"}</Typography>\n      <Typography variant={\"body2\"}>{search}</Typography>\n      <Box\n        display={\"flex\"}\n        flexWrap={\"wrap\"}\n        flexDirection={\"row\"}\n        justifyContent={\"center\"}\n      >\n        {currencies\n          .filter((x) => x.isSource && isInFilter(x))\n          .map((currency) => (\n            <ExchangeItem\n              key={currency.id}\n              currency={currency}\n              filter={search}\n            />\n          ))}\n      </Box>\n      <Divider variant={\"middle\"} />\n      <Typography variant={\"h5\"}>{\"Spend\"}</Typography>\n      <Box\n        display={\"flex\"}\n        flexWrap={\"wrap\"}\n        flexDirection={\"row\"}\n        justifyContent={\"center\"}\n      >\n        {currencies\n          .filter((x) => !x.isSource && isInFilter(x))\n          .map((currency) => (\n            <SpendItem key={currency.id} currency={currency} filter={search} />\n          ))}\n      </Box>\n    </Box>\n  );\n}\n","import { useMediaQuery } from '@material-ui/core';\n\nexport function useIsSmallScreen() {\n  return useMediaQuery('(max-width:425px)');\n}\n","import React from \"react\";\nimport { Currency, newUuid, usePLSDBContext } from \"../../data/PLSDB\";\nimport { useObservable } from \"../../Utils\";\nimport {\n  Box,\n  Icon,\n  Checkbox,\n  Button,\n  TextField,\n  Typography,\n  Card,\n} from \"@material-ui/core\";\nimport { useIsSmallScreen } from \"../../hooks/useIsSmallScreen\";\n\nfunction CurrencyItem({\n  currency,\n  isNew,\n}: {\n  currency: Currency;\n  isNew: boolean;\n}) {\n  const db = usePLSDBContext();\n  const [name, setName] = React.useState(() => currency.name);\n  const [icon, setIcon] = React.useState(() => currency.icon);\n  const [isSource, setIsSource] = React.useState(() => currency.isSource);\n  const [unit, setUnit] = React.useState(() => currency.unit);\n  const isSmallScreen = useIsSmallScreen();\n  const isEdited =\n    name !== currency.name ||\n    icon !== currency.icon ||\n    unit !== currency.unit ||\n    isSource !== currency.isSource;\n\n  const content = (\n    <>\n      {!isNew && <Icon>{currency.icon}</Icon>}\n      {isNew && (\n        <TextField\n          label={\"Icon\"}\n          value={icon}\n          onChange={(e) => setIcon(e.target.value)}\n        />\n      )}\n      <TextField\n        label={\"Name\"}\n        value={name}\n        onChange={(e) => setName(e.target.value)}\n      />\n      <TextField\n        label={\"Unit\"}\n        value={unit}\n        onChange={(e) => setUnit(e.target.value)}\n      />\n      <Typography>{\"Is time\"}</Typography>\n      <Checkbox checked={isSource} onChange={(e, v) => setIsSource(v)} />\n      <Typography>{\"Is source\"}</Typography>\n      {isEdited && (\n        <Button\n          onClick={() => {\n            db.addOrUpdateCurrency({\n              name,\n              icon,\n              unit,\n              isSource,\n              id: currency.id,\n            });\n          }}\n        >\n          <Icon>{\"save\"}</Icon>\n        </Button>\n      )}\n\n      {!isNew && (\n        <Button\n          onClick={() => {\n            db.removeCurrency(currency);\n          }}\n        >\n          <Icon>{\"delete\"}</Icon>\n        </Button>\n      )}\n    </>\n  );\n\n  if (isSmallScreen)\n    return (\n      <Card style={{ margin: 15 }}>\n        <Box\n          display={\"flex\"}\n          flexDirection={\"column\"}\n          alignItems={\"center\"}\n          justifyContent={\"space-between\"}\n          padding={1}\n        >\n          {content}\n        </Box>\n      </Card>\n    );\n\n  return (\n    <Box\n      display={\"flex\"}\n      flexDirection={\"row\"}\n      alignItems={\"center\"}\n      margin={1}\n      justifyContent={\"space-between\"}\n    >\n      {content}\n    </Box>\n  );\n}\n\nexport function SetupCurrencies() {\n  const db = usePLSDBContext();\n  const currencies = useObservable(db.getCurrencies(), []);\n  return (\n    <Box display={\"flex\"} flexDirection={\"column\"}>\n      {currencies.map((currency, i) => (\n        <CurrencyItem key={currency.name} currency={currency} isNew={false} />\n      ))}\n      <CurrencyItem\n        key={`new_currency_item_${currencies.length}`}\n        currency={{\n          name: `New currency ${currencies.length + 1}`,\n          icon: \"\",\n          isSource: false,\n          id: newUuid(),\n          unit: \"hour\",\n        }}\n        isNew={true}\n      />\n    </Box>\n  );\n}\n","import React from \"react\";\nimport { ExchangeRate, usePLSDBContext } from \"../../data/PLSDB\";\nimport { useObservable } from \"../../Utils\";\nimport {\n  Box,\n  Icon,\n  Button,\n  TextField,\n  Typography,\n  FormControl,\n  InputLabel,\n  MenuItem,\n  Select,\n  Card,\n} from \"@material-ui/core\";\nimport { useIsSmallScreen } from \"../../hooks/useIsSmallScreen\";\n\nfunction Item({ rate, isNew }: { rate?: ExchangeRate; isNew: boolean }) {\n  const db = usePLSDBContext();\n  const currencies = useObservable(db.getCurrencies(), []);\n  const [from, setFrom] = React.useState(() => rate?.from);\n  const [to, setTo] = React.useState(() => rate?.to);\n  const [rateValue, setRateValue] = React.useState(\n    () => rate?.rate.toString() ?? \"\"\n  );\n  const isSmallScreen = useIsSmallScreen();\n\n  const isEdited =\n    from !== rate?.from ||\n    to !== rate?.to ||\n    Number(rateValue) !== rate?.rate;\n  const isValid =\n    !isNaN(Number(rateValue)) &&\n    from != null &&\n    to != null &&\n    Number(rateValue) > 0;\n\n  const content = (\n    <>\n      <Box display={\"flex\"} flexDirection={\"row\"}>\n        <FormControl>\n          <InputLabel id=\"from-label-id\">{\"From\"}</InputLabel>\n          <Select\n            labelId=\"from-label-id\"\n            value={db.getCurrency(from ?? \"\")?.id}\n            onChange={(e: any, d: any) =>\n              setFrom(currencies.find((x) => x.id === e.target.value)?.id)\n            }\n          >\n            <MenuItem>{\"-\"}</MenuItem>\n            {currencies\n              .filter((x) => x.id !== to)\n              .map((currency, i) => (\n                <MenuItem key={currency.id + \"_from\"} value={currency.id}>\n                  {currency.name}\n                </MenuItem>\n              ))}\n          </Select>\n        </FormControl>\n        <Box marginX={1} />\n        <TextField\n          value={rateValue}\n          inputMode={\"decimal\"}\n          onChange={(e) => setRateValue(e.target.value)}\n          label={\"Rate\"}\n        />\n        <Box marginX={1} />\n        <FormControl>\n          <InputLabel id=\"to-label-id\">{\"To\"}</InputLabel>\n          <Select\n            labelId=\"to-label-id\"\n            value={db.getCurrency(to ?? \"\")?.id}\n            onChange={(e: any, d: any) =>\n              setTo(currencies.find((x) => x.id === e.target.value)?.id)\n            }\n          >\n            <MenuItem>{\"-\"}</MenuItem>\n            {currencies\n              .filter((x) => x.id !== from)\n              .map((currency, i) => (\n                <MenuItem key={currency.id + \"_to\"} value={currency.id}>\n                  {currency.name}\n                </MenuItem>\n              ))}\n          </Select>\n        </FormControl>\n      </Box>\n      {isValid && (\n        <Typography>{`1 ${db.getCurrency(from ?? \"\")?.unit} of ${db.getCurrency(from ?? \"\")?.name} = ${Number(rateValue)} ${\n          db.getCurrency(to ?? \"\")?.unit\n        } of ${db.getCurrency(to ?? \"\")?.name}`}</Typography>\n      )}\n\n      <Box display={\"flex\"} flexDirection={\"row\"}>\n        {isEdited && isValid && (\n          <Button\n            onClick={() => {\n              if (from == null || to == null) return;\n              db.addOrUpdateExchangeRate({\n                from: from,\n                to: to,\n                rate: Number(rateValue),\n              });\n            }}\n          >\n            <Icon>{\"save\"}</Icon>\n          </Button>\n        )}\n\n        {!isNew && rate != null && (\n          <Button\n            onClick={() => {\n              db.removeExchangeRate(rate);\n            }}\n          >\n            <Icon>{\"delete\"}</Icon>\n          </Button>\n        )}\n      </Box>\n    </>\n  );\n\n  if (isSmallScreen)\n    return (\n      <Card style={{ margin: 10 }}>\n        <Box\n          display={\"flex\"}\n          flexDirection={\"column\"}\n          alignItems={\"center\"}\n          margin={1}\n        >\n          {content}\n        </Box>\n      </Card>\n    );\n\n  return (\n    <Box\n      display={\"flex\"}\n      flexDirection={\"row\"}\n      alignItems={\"center\"}\n      margin={1}\n      justifyContent={\"space-between\"}\n    >\n      {content}\n    </Box>\n  );\n}\n\nexport function SetupExchangeRates() {\n  const db = usePLSDBContext();\n  const rates = useObservable(db.getExchangeRates(), []);\n  return (\n    <Box display={\"flex\"} flexDirection={\"column\"}>\n      {rates.map((rate, i) => (\n        <Item\n          key={rate.from + \"_\" + rate.to + \"_\" + rate.rate}\n          rate={rate}\n          isNew={false}\n        />\n      ))}\n      <Item key={rates.length} isNew={true} />\n    </Box>\n  );\n}\n","import * as React from \"react\";\nimport { Observable, BehaviorSubject, combineLatest } from \"rxjs\";\nimport {\n  distinct,\n  map,\n  skip,\n  debounceTime,\n  flatMap,\n  throttleTime,\n} from \"rxjs/operators\";\nconst PLACEHOLDER_GOAL = {\n  bounds: { top: 0, height: 50, left: 0, width: 50 },\n  name: \"\",\n  labels: [],\n};\nconst firebase = (window as any).firebase;\nexport const SystemsDBContext = React.createContext<SystemsDB | null>(null);\nexport function useSystemsDBContext(): SystemsDB {\n  const result = React.useContext(SystemsDBContext);\n  if (result == null)\n    throw new Error(\"useDBContext used outside of the context\");\n  return result;\n}\n\nexport type Goal = {\n  name: string;\n  labels: string[];\n  bounds: Rect;\n};\n\nexport type Connection = {\n  from: string;\n  to: string;\n};\n\nexport type Rect = {\n  left: number;\n  top: number;\n  width: number;\n  height: number;\n};\n\nexport type System = {\n  name: string;\n  labels: string[];\n  bounds: Rect;\n};\n\nexport type Position = { x: number; y: number };\n\nexport type Config = {\n  zoomLevel: number;\n  cameraPosition: Position;\n};\n\nexport function toKey(obj: Goal | Connection | System): string {\n  if (obj[\"name\"] != null) return obj[\"name\"];\n  return obj[\"from\"] + \":\" + obj[\"to\"];\n}\n\nexport class SystemsDB {\n  private _forceUpdate = new BehaviorSubject(null);\n  private goals = new BehaviorSubject<BehaviorSubject<Goal>[]>([]);\n  private connections = new BehaviorSubject<BehaviorSubject<Connection>[]>([]);\n  private systems = new BehaviorSubject<BehaviorSubject<System>[]>([]);\n  config = new BehaviorSubject({\n    zoomLevel: 1,\n    cameraPosition: { x: 0, y: 0 },\n  });\n\n  constructor() {\n    combineLatest(\n      this.goals.pipe(\n        skip(1),\n        map((x) => JSON.stringify(x.map((x) => x.value))),\n        distinct()\n      ),\n      this.connections.pipe(\n        skip(1),\n        map((x) => JSON.stringify(x.map((x) => x.value))),\n        distinct()\n      ),\n      this.systems.pipe(\n        skip(1),\n        map((x) => JSON.stringify(x.map((x) => x.value))),\n        distinct()\n      ),\n      this.config.pipe(\n        skip(1),\n        map((x) => JSON.stringify(x)),\n        distinct()\n      ),\n      this._forceUpdate\n    )\n      .pipe(debounceTime(1000))\n      .subscribe({ next: () => this.save() });\n  }\n\n  getGoalInitialValue(key: string): Goal {\n    const result = this.goals.value.find((x) => toKey(x.value) === key)?.value;\n    if (result == null) return PLACEHOLDER_GOAL;\n    return result;\n  }\n\n  getGoalWithKey(key: string): Observable<Goal> {\n    const result = this.goals.value.find((x) => toKey(x.value) === key);\n    if (result == null) return new BehaviorSubject(PLACEHOLDER_GOAL);\n    return result;\n  }\n\n  updateGoalWithKey(key: string, updated: (current: Goal) => Goal) {\n    const result = this.goals.value.find((x) => toKey(x.value) === key);\n    if (result == null) return;\n    const newValue = updated(result.value);\n    if (\n      this.goals.value.find(\n        (x) => toKey(x.value) === toKey(newValue) && x !== result\n      ) != null\n    ) {\n      alert(\"There is already another goal with this name\");\n      return;\n    } else {\n      result.next(newValue);\n      this._forceUpdate.next(null);\n    }\n  }\n\n  deleteGoal(key: string) {\n    // let goal: Goal | null = null;\n    this.goals.next(\n      this.goals.value.filter((x) => {\n        if (toKey(x.value) !== key) {\n          // goal = x.value;\n          return true;\n        }\n        return false;\n      })\n    );\n    // if (goal != null) {\n    //   const goalKey = toKey(goal);\n    //   this.connections.next(\n    //     this.connections.value.filter(\n    //       (x) => x.value.from === goalKey || x.value.to === goalKey\n    //     )\n    //   );\n    // }\n  }\n\n  createGoal(goal: Goal) {\n    this.goals.next([...this.goals.value, new BehaviorSubject(goal)]);\n  }\n\n  getZoomLevel(): Observable<number> {\n    return this.config.pipe(\n      distinct(),\n      map((x) => x.zoomLevel)\n    );\n  }\n\n  getCameraPosition(): Observable<Position> {\n    return this.config.pipe(\n      distinct(),\n      map((x) => x.cameraPosition)\n    );\n  }\n\n  getGoalsWithKey(): Observable<[Observable<Goal>, string][]> {\n    return this.goals.pipe(map((x) => x.map((y) => [y, toKey(y.value)])));\n  }\n\n  getSystemsWithKey(): Observable<[Observable<System>, string][]> {\n    return this.systems.pipe(map((x) => x.map((y) => [y, toKey(y.value)])));\n  }\n\n  getConnectionsWithKeys(): Observable<[Connection, string][]> {\n    return this.connections.pipe(\n      map((x) => x.map((y) => [y.value, toKey(y.value)]))\n    );\n  }\n\n  deleteConnection(key: string) {\n    this.connections.next(\n      this.connections.value.filter((x) => toKey(x.value) !== key)\n    );\n  }\n\n  createConnection({ from, to }: { from: Goal; to: Goal }) {\n    this.connections.next([\n      ...this.connections.value,\n      new BehaviorSubject({ from: toKey(from), to: toKey(to) }),\n    ]);\n  }\n\n  getSystemGoals(_system: System | string): Observable<Observable<Goal>[]> {\n    const sysSubject = this.systems.value.find(\n      (x) =>\n        toKey(x.value) ===\n        (typeof _system === \"string\" ? _system : toKey(_system))\n    );\n    if (sysSubject == null) throw new Error(\"System not found\");\n    return combineLatest(sysSubject, this.goals).pipe(\n      throttleTime(30),\n      map(([system]) =>\n        this.goals.pipe(\n          throttleTime(30),\n          map((x) =>\n            x.filter((x) => isBoundAinY(x.value.bounds, system.bounds))\n          )\n        )\n      ),\n      flatMap((x) => x)\n    );\n  }\n\n  getSystemInitialValue(key: string): System {\n    const result = this.systems.value.find((x) => toKey(x.value) === key)\n      ?.value;\n    if (result == null) throw new Error(\"System not found\");\n    return result;\n  }\n\n  updateSystemWithKey(key: string, updated: (current: System) => System) {\n    const result = this.systems.value.find((x) => toKey(x.value) === key);\n    if (result == null) throw new Error(\"System not found\");\n    const newValue = updated(result.value);\n    if (\n      this.systems.value.find(\n        (x) => toKey(x.value) === toKey(newValue) && x !== result\n      ) != null\n    ) {\n      alert(\"There is already another goal with this name\");\n      return;\n    } else {\n      result.next(newValue);\n      this._forceUpdate.next(null);\n    }\n  }\n\n  deleteSystem(key: string) {\n    this.systems.next(this.systems.value.filter((x) => toKey(x.value) !== key));\n  }\n\n  createSystem(goal: Goal) {\n    this.systems.next([...this.systems.value, new BehaviorSubject(goal)]);\n  }\n\n  dbRef: any;\n\n  loadFromFirebase(uid: string) {\n    this.dbRef = firebase.database().ref(`systems/${uid}`);\n    this.dbRef.on(\"value\", (s: any) => {\n      console.log(\"Updating Systems\");\n      const result = JSON.parse(s.val() ?? \"{}\");\n      const goals: Goal[] = result[\"goals\"] ?? [];\n      const systems: System[] = result[\"systems\"] ?? [];\n      const connections: Connection[] = result[\"connections\"] ?? [];\n      const config: Config = result[\"config\"] ?? {\n        zoomLevel: 1,\n        cameraPosition: { x: 0, y: 0 },\n      };\n      if (JSON.stringify(config) !== JSON.stringify(this.config.value))\n        this.config.next(config);\n      updateFromDiff(this.goals, goals);\n      updateFromDiff(this.systems, systems);\n      updateFromDiff(this.connections, connections);\n    });\n  }\n\n  save() {\n    const result = {\n      goals: this.goals.value.map((x) => x.value),\n      systems: this.systems.value.map((x) => x.value),\n      connections: this.connections.value.map((x) => x.value),\n      config: this.config.value,\n    };\n    const data = JSON.stringify(result);\n    this.dbRef.set(data);\n    console.log(\"Saving Systems\");\n  }\n}\n\ntype SystesmDBEntities = System | Goal | Connection;\n\nfunction updateFromDiff<T extends SystesmDBEntities>(\n  old: BehaviorSubject<BehaviorSubject<T>[]>,\n  _new: T[]\n) {\n  const indexedOldTargets: {\n    [key: string]: BehaviorSubject<T>;\n  } = {};\n  const oldTargets = old.value.map((v) => {\n    indexedOldTargets[toKey(v.value)] = v;\n    return v.value;\n  });\n\n  const targetsDiff = findDiff(oldTargets, _new);\n  const targetUpdateResult: BehaviorSubject<T>[] = [\n    ...targetsDiff.newAdded.map((x) => new BehaviorSubject(x)),\n  ];\n  targetsDiff.existed.forEach((item) => {\n    const _subject = indexedOldTargets[toKey(item)];\n    targetUpdateResult.push(_subject);\n    if (JSON.stringify(_subject.value) !== JSON.stringify(item)) {\n      _subject.next(item);\n    }\n  });\n  old.next(targetUpdateResult);\n}\n\nfunction findDiff<T extends SystesmDBEntities>(\n  _olds: T[],\n  news: T[]\n): {\n  newAdded: T[];\n  deleted: T[];\n  existed: T[];\n} {\n  const newAdded: T[] = [];\n  const existed: T[] = [];\n  outer: for (const _new of news) {\n    for (const _old of _olds) {\n      if (toKey(_old) === toKey(_new)) {\n        existed.push(_new);\n        continue outer;\n      }\n    }\n    newAdded.push(_new);\n  }\n  const deleted = _olds.filter(\n    (x) => !existed.map((x) => toKey(x)).includes(toKey(x))\n  );\n\n  return {\n    newAdded,\n    deleted,\n    existed,\n  };\n}\n\nif (process.env.NODE_ENV === \"development\") {\n  // TODO: add these to test\n  const _win = window as any;\n  const connSet1: any[] = [\n    {\n      name: \"a\",\n      labels: [\"test1\"],\n    },\n    {\n      name: \"b\",\n    },\n    {\n      name: \"c\",\n    },\n  ];\n  const connSet2: any[] = [\n    {\n      name: \"a\",\n      labels: [],\n    },\n\n    {\n      name: \"c\",\n    },\n    {\n      name: \"k\",\n    },\n  ];\n  _win.findDiff = () => findDiff(connSet1, connSet2);\n}\n\nfunction isBoundAinY(a: Rect, b: Rect): boolean {\n  if (a.left <= b.left) return false;\n  if (a.top <= b.top) return false;\n  if (a.left + a.width >= b.left + b.width) return false;\n  if (a.top + a.height >= b.top + b.height) return false;\n\n  return true;\n}\n\nexport function CreateOrGetDefaultSystemsDatabase(): SystemsDB {\n  const db = new SystemsDB();\n  return db;\n}\n","import React from \"react\";\nimport { fromEvent, BehaviorSubject } from \"rxjs\";\nimport { debounceTime, take, skip } from \"rxjs/operators\";\nimport { makeStyles } from \"@material-ui/styles\";\nimport { Config, useSystemsDBContext } from \"../../../data/SystemsDB\";\n\nconst useStyles = makeStyles({\n  rootContainer: {\n    \"&::-webkit-scrollbar\": {\n      display: \"none\",\n    },\n  },\n  innerContainer: {\n    // TODO: max everything width + padding\n    width: \"100%\",\n    // TODO: max everyhing height + padding\n    height: \"100%\",\n    position: \"relative\",\n  },\n});\n\nfunction useIsHoldinMouseKey(keyCode: number): boolean {\n  const [isDown, setIsDown] = React.useState(false);\n  React.useEffect(() => {\n    const onMouseDown = (e: MouseEvent) => {\n      if (e.button === keyCode) setIsDown(true);\n    };\n    const onMouseUp = (e: MouseEvent) => {\n      if (e.button === keyCode) setIsDown(false);\n    };\n    window.document.addEventListener(\"mousedown\", onMouseDown);\n    window.document.addEventListener(\"mouseup\", onMouseUp);\n    return () => {\n      window.document.removeEventListener(\"mousedown\", onMouseDown);\n      window.document.removeEventListener(\"mouseup\", onMouseUp);\n    };\n  }, [keyCode]);\n  return isDown;\n}\n\nfunction calculateTransform({ zoomLevel, cameraPosition }: Config): string {\n  return `transform:translate(${cameraPosition.x}px,${cameraPosition.y}px) scale(${zoomLevel})`;\n}\n\nexport function Canvas(props: React.Props<{}>) {\n  const containerRef = React.useRef<HTMLDivElement>();\n  const innerRef = React.useRef<HTMLDivElement>();\n  const positionRef = React.useRef<HTMLParagraphElement>();\n  const db = useSystemsDBContext();\n  const styles = useStyles({});\n  const [size, setSize] = React.useState({ width: 0, height: 0 });\n  const isHoldingMouseMiddleButton = useIsHoldinMouseKey(1);\n  const [, setScale] = React.useState(1);\n  const config = React.useMemo<Config>(() => db.config.value, [db]);\n\n  const updateDbConfig = React.useCallback(() => {\n    db.config.next(config);\n  }, [db.config, config]);\n\n  const updateInnerRefStyle = React.useCallback(\n    (animate: boolean = false) => {\n      if (innerRef.current == null)\n        throw new Error(\"Unhandled situtation innerRef cannot be null here\");\n      if (positionRef.current != null) {\n        positionRef.current.innerText = `${config.cameraPosition.x}, ${\n          config.cameraPosition.y\n        } (x${config.zoomLevel.toPrecision(2)})`;\n      }\n\n      let value = calculateTransform(config);\n      const ANIMATION = \";transition: transform 100ms\";\n      if (animate) {\n        innerRef.current.setAttribute(\n          \"style\",\n          innerRef.current.style + ANIMATION\n        );\n        value += ANIMATION;\n      }\n\n      innerRef.current.setAttribute(\"style\", value);\n    },\n    [innerRef, config, positionRef]\n  );\n\n  React.useEffect(() => {\n    updateInnerRefStyle(false);\n  }, [updateInnerRefStyle]);\n\n  React.useEffect(() => {\n    // skip default value and wait for server value\n    const sub = db.config.pipe(skip(1), take(1)).subscribe({\n      next: (v) => {\n        config.cameraPosition = v.cameraPosition;\n        config.zoomLevel = v.zoomLevel;\n        updateInnerRefStyle(false);\n      },\n    });\n    return () => sub.unsubscribe();\n  }, [db, config, updateInnerRefStyle]);\n\n  // on space reset zoom to 1\n  React.useEffect(() => {\n    const onKeyUp = (e: KeyboardEvent) => {\n      const SPACE_KEY_CODE = 32;\n      if (e.keyCode === SPACE_KEY_CODE) {\n        config.zoomLevel = 1;\n        updateInnerRefStyle(true);\n        updateDbConfig();\n      }\n    };\n    window.document.addEventListener(\"keyup\", onKeyUp);\n    return () => window.document.removeEventListener(\"keyup\", onKeyUp);\n  }, [updateInnerRefStyle, config, updateDbConfig]);\n\n  // zoom\n  React.useEffect(() => {\n    const _doUpdateScale = new BehaviorSubject(null);\n    const sub = _doUpdateScale.pipe(debounceTime(100)).subscribe({\n      next: () => setScale(config.zoomLevel),\n    });\n    const onMouseWheel = (e: WheelEvent) => {\n      config.zoomLevel = Math.max(0.1, config.zoomLevel + e.deltaY * -0.0005);\n      updateDbConfig();\n      updateInnerRefStyle(true);\n      _doUpdateScale.next(null);\n    };\n    window.document.addEventListener(\"wheel\", onMouseWheel);\n    return () => {\n      window.document.removeEventListener(\"wheel\", onMouseWheel);\n      sub.unsubscribe();\n    };\n  }, [updateInnerRefStyle, config, updateDbConfig]);\n\n  React.useLayoutEffect(() => {\n    if (!isHoldingMouseMiddleButton) {\n      document.body.style.cursor = \"default\";\n      return;\n    } else {\n      document.body.style.cursor = \"move\";\n    }\n\n    const onMouseMove = (e: MouseEvent) => {\n      config.cameraPosition.x += e.movementX;\n      config.cameraPosition.y += e.movementY;\n      updateDbConfig();\n      // we directly update innerRef attribute because of performance resaons\n      updateInnerRefStyle();\n    };\n    document.addEventListener(\"mousemove\", onMouseMove);\n    return () => document.removeEventListener(\"mousemove\", onMouseMove);\n  }, [\n    isHoldingMouseMiddleButton,\n    innerRef,\n    updateInnerRefStyle,\n    config,\n    updateDbConfig,\n  ]);\n\n  // setup width and height\n  React.useLayoutEffect(() => {\n    const calculateAndUpdateSize = () => {\n      if (containerRef.current == null) throw new Error(\"Unhandled situtation\");\n      const height =\n        window.innerHeight - containerRef.current.getBoundingClientRect().top;\n      const width = window.innerWidth;\n      setSize({ height, width });\n    };\n    calculateAndUpdateSize();\n    const sub = fromEvent(window, \"resize\")\n      .pipe(debounceTime(50))\n      .subscribe({ next: () => calculateAndUpdateSize() });\n\n    return () => sub.unsubscribe();\n  }, [containerRef]);\n\n  return (\n    <div\n      ref={containerRef as any}\n      className={styles.rootContainer}\n      id=\"canvas\"\n      style={{\n        width: size.width,\n        height: size.height,\n        position: \"relative\",\n        overflow: \"hidden\",\n      }}\n    >\n      <div ref={innerRef as any} className={styles.innerContainer}>\n        {props.children}\n      </div>\n      <p\n        ref={positionRef as any}\n        style={{ position: \"absolute\", bottom: 0, right: 20, opacity: 0.5 }}\n      ></p>\n    </div>\n  );\n}\n","import React from \"react\";\n\ntype BorderTriggerEvent = {\n  state: \"entered\" | \"exited\";\n};\n\ntype TriggerEvent = (e: BorderTriggerEvent) => void;\n\nexport function BorderTrigger(props: {\n  children: React.ReactNode;\n  borderWidth: number;\n  style?: React.CSSProperties;\n  onTL?: TriggerEvent;\n  onT?: TriggerEvent;\n  onTR?: TriggerEvent;\n  onL?: TriggerEvent;\n  onR?: TriggerEvent;\n  onBL?: TriggerEvent;\n  onB?: TriggerEvent;\n  onBR?: TriggerEvent;\n  onMouseDown?: (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n  onMouseMove?: (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n  onMouseUp?: (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n}) {\n  /*\n  [ ]---------[ ]\n   |           |\n   |   child   |\n   |           |\n  [ ]---------[ ]\n  */\n  const rowStyle: React.CSSProperties = {\n    display: \"flex\",\n    flexDirection: \"row\",\n  };\n  const cornerStyle: React.CSSProperties = {\n    width: props.borderWidth,\n    height: props.borderWidth,\n  };\n  const hLineStyle: React.CSSProperties = {\n    flex: 1,\n    height: props.borderWidth,\n  };\n  const vLineStyle: React.CSSProperties = {\n    width: props.borderWidth,\n  };\n  return (\n    <div\n      style={{\n        ...(props.style ?? {}),\n        display: \"flex\",\n        flexDirection: \"column\",\n      }}\n      onMouseMove={props.onMouseMove}\n    >\n      <div style={rowStyle}>\n        <div\n          onMouseEnter={\n            props.onTL == null\n              ? undefined\n              : () => props.onTL!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onTL == null\n              ? undefined\n              : () => props.onTL!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...cornerStyle, cursor: \"nw-resize\" }}\n        ></div>\n        <div\n          onMouseEnter={\n            props.onT == null\n              ? undefined\n              : () => props.onT!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onT == null\n              ? undefined\n              : () => props.onT!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...hLineStyle, cursor: \"n-resize\" }}\n        ></div>\n        <div\n          onMouseEnter={\n            props.onTR == null\n              ? undefined\n              : () => props.onTR!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onTR == null\n              ? undefined\n              : () => props.onTR!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...cornerStyle, cursor: \"ne-resize\" }}\n        ></div>\n      </div>\n      <div style={rowStyle}>\n        <div\n          onMouseEnter={\n            props.onL == null\n              ? undefined\n              : () => props.onL!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onL == null\n              ? undefined\n              : () => props.onL!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...vLineStyle, cursor: \"w-resize\" }}\n        ></div>\n        <div style={{width: \"100%\", height: \"100%\"}}>{props.children}</div>\n        <div\n          onMouseEnter={\n            props.onR == null\n              ? undefined\n              : () => props.onR!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onR == null\n              ? undefined\n              : () => props.onR!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...vLineStyle, cursor: \"w-resize\" }}\n        ></div>\n      </div>\n      <div style={rowStyle}>\n        <div\n          onMouseEnter={\n            props.onBL == null\n              ? undefined\n              : () => props.onBL!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onBL == null\n              ? undefined\n              : () => props.onBL!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...cornerStyle, cursor: \"sw-resize\" }}\n        ></div>\n        <div\n          onMouseEnter={\n            props.onB == null\n              ? undefined\n              : () => props.onB!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onB == null\n              ? undefined\n              : () => props.onB!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...hLineStyle, cursor: \"n-resize\" }}\n        ></div>\n        <div\n          onMouseEnter={\n            props.onBR == null\n              ? undefined\n              : () => props.onBR!({ state: \"entered\" })\n          }\n          onMouseLeave={\n            props.onBR == null\n              ? undefined\n              : () => props.onBR!({ state: \"exited\" })\n          }\n          onMouseDown={props.onMouseDown}\n          onMouseUp={props.onMouseUp}\n          style={{ ...cornerStyle, cursor: \"se-resize\" }}\n        ></div>\n      </div>\n    </div>\n  );\n}\n","import * as React from \"react\";\n\nimport Draggable from \"react-draggable\";\nimport { Rect } from \"../../../data/SystemsDB\";\nimport { BorderTrigger } from \"./BorderTrigger\";\nimport { Observable } from \"rxjs\";\nimport { filter } from \"rxjs/operators\";\nimport { useForceUpdate } from \"../../../Utils\";\n\nexport type UpdateManager = {\n  updates: Observable<Rect>;\n  sendUpdate: (e: Rect) => void;\n  initial: Rect;\n};\n\nexport function CanvasNode(props: {\n  children: (bounds: Rect) => React.ReactNode;\n  scale: number;\n  updateManager: UpdateManager;\n  offsetPosition?: { x: number, y: number}\n}) {\n  const isHoldingBorder = React.useRef(false);\n  const containerRef = React.useRef<HTMLDivElement>();\n  const bounds = React.useMemo<Rect>(() => props.updateManager.initial, [\n    props.updateManager,\n  ]);\n  const forceRefresh = useForceUpdate();\n  const lastBorderState = React.useRef<\n    \"tl\" | \"t\" | \"tr\" | \"l\" | \"r\" | \"br\" | \"b\" | \"bl\" | \"none\"\n  >(\"none\");\n\n  const update = React.useCallback(\n    (calculate: (c: Rect) => Rect) => {\n      const result = calculate(bounds);\n      const filteredResult = {\n        ...result,\n        width: Math.max(result.width, 100),\n        height: Math.max(result.height, 70),\n      };\n      Object.assign(bounds, filteredResult);\n      forceRefresh();\n      setTimeout(() => props.updateManager.sendUpdate(bounds), 50);\n    },\n    [bounds, forceRefresh, props.updateManager]\n  );\n\n  React.useEffect(() => {\n    const sub = props.updateManager.updates\n      .pipe(\n        filter(\n          (x) =>\n            x.width !== bounds.width ||\n            x.height !== bounds.height ||\n            x.top !== bounds.top ||\n            x.left !== bounds.left\n        )\n      )\n      .subscribe({\n        next: (v) => update(() => v),\n      });\n    return () => sub.unsubscribe();\n  }, [props.updateManager, bounds, update]);\n\n  React.useEffect(() => {\n    const onMouseMove = (e: MouseEvent) => {\n      if (!isHoldingBorder.current) return;\n      const movementX = e.movementX;\n      const movementY = e.movementY;\n\n      if (lastBorderState.current === \"r\")\n        update((c) => ({\n          ...c,\n          width: c.width + movementX,\n        }));\n      if (lastBorderState.current === \"br\")\n        update((c) => ({\n          ...c,\n          width: c.width + movementX,\n          height: c.height + movementY,\n        }));\n      if (lastBorderState.current === \"b\")\n        update((c) => ({\n          ...c,\n          height: c.height + movementY,\n        }));\n      if (lastBorderState.current === \"bl\")\n        update((c) => ({\n          ...c,\n          width: c.width + -movementX,\n          left: c.left + movementX,\n          height: c.height + movementY,\n        }));\n      if (lastBorderState.current === \"l\")\n        update((c) => ({\n          ...c,\n          width: c.width + -movementX,\n          left: c.left + movementX,\n        }));\n      if (lastBorderState.current === \"tl\")\n        update((c) => ({\n          ...c,\n          width: c.width + -movementX,\n          top: c.top + movementY,\n          left: c.left + movementX,\n          height: c.height + -movementY,\n        }));\n      if (lastBorderState.current === \"t\")\n        update((c) => ({\n          ...c,\n          top: c.top + movementY,\n          height: c.height + -movementY,\n        }));\n      if (lastBorderState.current === \"tr\")\n        update((c) => ({\n          ...c,\n          width: c.width + movementX,\n          top: c.top + movementY,\n          height: c.height + -movementY,\n        }));\n    };\n    const onMouseUp = (e: MouseEvent) => {\n      isHoldingBorder.current = false;\n    };\n    document.addEventListener(\"mousemove\", onMouseMove);\n    document.addEventListener(\"mouseup\", onMouseUp);\n    return () => {\n      document.removeEventListener(\"mousemove\", onMouseMove);\n      document.removeEventListener(\"mouseup\", onMouseUp);\n    };\n  }, [isHoldingBorder, lastBorderState, props.scale, update]);\n\n  const onMouseDown = (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\n    isHoldingBorder.current = true;\n  };\n  return (\n    <Draggable\n      handle=\".handle\"\n      position={{ x: bounds.left, y: bounds.top }}\n      onDrag={(e, d) => {\n        update((c) => ({\n          ...c,\n          left: d.x,\n          top: d.y,\n        }));\n      }}\n      positionOffset={props.offsetPosition}\n      scale={props.scale}\n    >\n      <div ref={containerRef as any} style={{ position: \"absolute\" }}>\n        <BorderTrigger\n          onMouseDown={onMouseDown}\n          borderWidth={10}\n          onL={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"l\")\n          }\n          onR={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"r\")\n          }\n          onTL={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"tl\")\n          }\n          onT={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"t\")\n          }\n          onTR={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"tr\")\n          }\n          onBL={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"bl\")\n          }\n          onB={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"b\")\n          }\n          onBR={() =>\n            !isHoldingBorder.current && (lastBorderState.current = \"br\")\n          }\n        >\n          {props.children(bounds)}\n        </BorderTrigger>\n      </div>\n    </Draggable>\n  );\n}\n","import * as React from \"react\";\nimport { Card, Icon, Box, Chip } from \"@material-ui/core\";\nimport { Observable } from \"rxjs\";\nimport { map, tap } from \"rxjs/operators\";\nimport { CanvasNode, UpdateManager } from \"./CanvasNode\";\nimport { Goal, useSystemsDBContext } from \"../../../data/SystemsDB\";\nimport { useObservable } from \"../../../Utils\";\n\ntype GoalProps = {\n  goal: Observable<Goal>;\n  goalKey: string;\n  scale: number;\n  selectedGoal?: Goal;\n  onClick: (goal: Goal) => void;\n};\n\nexport function GoalView(props: GoalProps) {\n  const goal = useObservable(props.goal, null);\n  const isSelected = props.selectedGoal?.name === goal?.name;\n  const positionRef = React.useRef<HTMLParagraphElement>();\n  const db = useSystemsDBContext();\n  const updateManager = React.useMemo<UpdateManager>(\n    () => ({\n      sendUpdate: (v) =>\n        db.updateGoalWithKey(props.goalKey, (current) => ({\n          ...current,\n          bounds: v,\n        })),\n      initial: db.getGoalInitialValue(props.goalKey).bounds,\n      updates: props.goal.pipe(\n        map((v) => v.bounds),\n        tap((x) => {\n          if (positionRef.current != null) {\n            const _pos = `${x.left.toFixed(2)}, ${x.top.toFixed(2)}`;\n            const _bounds = `w${x.width.toFixed()}h${x.height.toFixed()}`;\n            positionRef.current.innerText = `${_pos} ${_bounds};`;\n          }\n        })\n      ),\n    }),\n    [props.goalKey, db, props.goal]\n  );\n  if (goal == null) return null;\n\n  return (\n    <CanvasNode updateManager={updateManager} scale={props.scale}>\n      {(bounds) => (\n        <Card\n          onClick={() => props.onClick(goal)}\n          elevation={4}\n          variant={isSelected ? \"elevation\" : \"outlined\"}\n          style={{\n            padding: 5,\n            width: bounds.width,\n            height: bounds.height,\n            display: \"flex\",\n            flexDirection: \"column\",\n            userSelect: \"none\",\n            justifyContent: \"space-between\",\n          }}\n        >\n          <div style={{ display: \"flex\", flexDirection: \"row\" }}>\n            <Icon className=\"handle\">{\"drag_handle\"}</Icon>\n            <Icon\n              style={{ cursor: \"pointer\" }}\n              onClick={() => {\n                const isConfirmed = window.confirm(\n                  \"Are you sure you want to delete this goal?\"\n                );\n                if (!isConfirmed) return;\n                db.deleteGoal(props.goalKey);\n              }}\n            >\n              {\"delete\"}\n            </Icon>\n          </div>\n          <div\n            style={{\n              display: \"flex\",\n              flexDirection: \"row\",\n              flexWrap: \"wrap\",\n              alignItems: \"baseline\",\n              fontSize: 30,\n              alignSelf: \"center\",\n              cursor: \"pointer\",\n            }}\n            className=\"content\"\n            onClick={() => {\n              const newName = prompt(\"Enter goal name\", goal.name);\n              if (newName == null) return;\n              db.updateGoalWithKey(props.goalKey, (c) => ({\n                ...c,\n                name: newName,\n              }));\n            }}\n            dangerouslySetInnerHTML={{ __html: goal.name }}\n          ></div>\n          <Box display=\"flex\" flexDirection=\"row\" flexWrap=\"warp\">\n            {goal.labels.map((label, i) => (\n              <Chip\n                onClick={() => {\n                  const isConfirmed = window.confirm(\n                    \"Are you sure you want to delete this label?\"\n                  );\n                  if (!isConfirmed) return;\n                  db.updateGoalWithKey(props.goalKey, (c) => ({\n                    ...c,\n                    labels: c.labels.filter((x) => x !== label),\n                  }));\n                }}\n                style={{ margin: 3 }}\n                size=\"small\"\n                key={i}\n                label={label}\n              />\n            ))}\n            <Chip\n              onClick={() => {\n                const labelValue = prompt(\"Enter label text\");\n                if (labelValue == null) return;\n                db.updateGoalWithKey(props.goalKey, (c) => ({\n                  ...c,\n                  labels: [...c.labels, labelValue],\n                }));\n              }}\n              style={{ margin: 3, cursor: \"pointer\" }}\n              size=\"small\"\n              color=\"primary\"\n              label={\"+\"}\n            />\n          </Box>\n          <p\n            ref={positionRef as any}\n            style={{ position: \"absolute\", bottom: 0, right: 20, opacity: 0.5 }}\n          ></p>\n        </Card>\n      )}\n    </CanvasNode>\n  );\n}\n","import * as React from \"react\";\nimport { Observable } from \"rxjs\";\nimport { map, tap } from \"rxjs/operators\";\nimport { CanvasNode, UpdateManager } from \"./CanvasNode\";\nimport { System, useSystemsDBContext } from \"../../../data/SystemsDB\";\nimport { useObservable } from \"../../../Utils\";\nimport { Icon } from \"@material-ui/core\";\n\ntype SystemProps = {\n  system: Observable<System>;\n  systemKey: string;\n  scale: number;\n  onClick?: (system: System) => void;\n};\n\nexport function SystemView(props: SystemProps) {\n  const system = useObservable(props.system, null);\n  const db = useSystemsDBContext();\n  const positionRef = React.useRef<HTMLParagraphElement>();\n  const systemGoals = useObservable(\n    () => db.getSystemGoals(props.systemKey),\n    []\n  );\n  const updateManager = React.useMemo<UpdateManager>(\n    () => ({\n      sendUpdate: (v) =>\n        db.updateSystemWithKey(props.systemKey, (current) => ({\n          ...current,\n          bounds: v,\n        })),\n      initial: db.getSystemInitialValue(props.systemKey).bounds,\n      updates: props.system.pipe(\n        map((v) => v.bounds),\n        tap((x) => {\n          if (positionRef.current != null) {\n            const _pos = `${x.left.toFixed(2)}, ${x.top.toFixed(2)}`;\n            const _bounds = `w${x.width.toFixed()}h${x.height.toFixed()}`;\n            positionRef.current.innerText = `${_pos} ${_bounds};`;\n          }\n        })\n      ),\n    }),\n    [props.systemKey, db, props.system]\n  );\n  if (system == null) return null;\n  const borderColor = \"rgba(0,0,0,0.6)\";\n  const systemNameBorder = `${borderColor} dashed`;\n  return (\n    <CanvasNode updateManager={updateManager} scale={props.scale}>\n      {(bounds) => (\n        <div\n          onClick={() => props.onClick != null && props.onClick(system)}\n          style={{\n            padding: 5,\n            width: bounds.width,\n            height: bounds.height,\n            display: \"flex\",\n            flexDirection: \"column\",\n            justifyContent: \"space-between\",\n            borderColor: borderColor,\n            borderWidth: 2,\n            borderStyle: \"dashed\",\n            borderRadius: 5,\n            borderTopLeftRadius: 0,\n            pointerEvents: \"visible\",\n          }}\n        >\n          <Icon className=\"handle\">{\"drag_handle\"}</Icon>\n          <Icon\n            style={{ cursor: \"pointer\", position: \"absolute\", left: 50 }}\n            onClick={() => {\n              const isConfirmed = window.confirm(\n                \"Are you sure you want to delete this system?\"\n              );\n              if (!isConfirmed) return;\n              db.deleteSystem(props.systemKey);\n            }}\n          >\n            {\"delete\"}\n          </Icon>\n          <p\n            style={{ position: \"absolute\", bottom: 0, left: 15 }}\n          >{`${systemGoals.length} Goals`}</p>\n          <div\n            style={{\n              position: \"absolute\",\n              top: -38,\n              fontSize: \"25pt\",\n              paddingLeft: 5,\n              paddingRight: 5,\n              left: 10,\n              borderLeft: systemNameBorder,\n              borderTop: systemNameBorder,\n              borderRight: systemNameBorder,\n              borderWidth: 2,\n            }}\n            onClick={() => {\n              const newName = prompt(\"Enter system name\", system.name);\n              if (newName == null) return;\n              db.updateSystemWithKey(props.systemKey, (c) => ({\n                ...c,\n                name: newName,\n              }));\n            }}\n            dangerouslySetInnerHTML={{ __html: system.name }}\n          ></div>\n          <p\n            ref={positionRef as any}\n            style={{ position: \"absolute\", bottom: 0, right: 20, opacity: 0.5 }}\n          ></p>\n        </div>\n      )}\n    </CanvasNode>\n  );\n}\n","import * as React from \"react\";\nimport { useSystemsDBContext, toKey } from \"../../../data/SystemsDB\";\nimport { getBoxToBoxArrow } from \"perfect-arrows\";\nimport { useObservable } from \"../../../Utils\";\ntype ConnectionProps = {};\n\nexport function ConnectionsView(props: ConnectionProps) {\n  const db = useSystemsDBContext();\n  const connections = useObservable(() => db.getConnectionsWithKeys(), []);\n  return (\n    <svg\n      style={{\n        width: \"100%\",\n        overflow: \"visible\",\n        height: \"100%\",\n      }}\n      stroke=\"#000\"\n      fill=\"#000\"\n      strokeWidth={3}\n    >\n      {connections.map(([connection, key]) => (\n        <ConnectionView\n          fromGoalKey={connection.from}\n          toGoalKey={connection.to}\n          key={key}\n        />\n      ))}\n    </svg>\n  );\n}\n\nfunction ConnectionView({\n  fromGoalKey,\n  toGoalKey,\n}: {\n  fromGoalKey: string;\n  toGoalKey: string;\n}) {\n  const db = useSystemsDBContext();\n  const from = useObservable(\n    () => db.getGoalWithKey(fromGoalKey),\n    db.getGoalInitialValue(fromGoalKey)\n  );\n  const to = useObservable(\n    () => db.getGoalWithKey(toGoalKey),\n    db.getGoalInitialValue(toGoalKey)\n  );\n  const [sx, sy, cx, cy, ex, ey, ae,] = getBoxToBoxArrow(\n    from.bounds.left,\n    from.bounds.top,\n    from.bounds.width + 20,\n    from.bounds.height + 20,\n    to.bounds.left,\n    to.bounds.top ,\n    to.bounds.width + 20,\n    to.bounds.height + 20, {\n      bow: 0.1\n    }\n  );\n\n  const endAngleAsDegrees = ae * (180 / Math.PI);\n  console.log(sx, sy);\n  return (\n    <>\n      <circle cx={sx} cy={sy} r={4} />\n      <path\n        d={`M${sx},${sy} Q${cx},${cy} ${ex},${ey}`}\n        fill=\"none\"\n        onClick={() => {\n          const isConfirmed = window.confirm(\n            \"Are you sure you want to delete this connection?\"\n          );\n          if (!isConfirmed) return;\n          db.deleteConnection(toKey({ from: fromGoalKey, to: toGoalKey }));\n        }}\n      />\n      <polygon\n        points=\"0,-6 12,0, 0,6\"\n        transform={`translate(${ex},${ey}) rotate(${endAngleAsDegrees})`}\n      />\n    </>\n  );\n}\n","import * as React from \"react\";\nimport { Canvas } from \"./Canvas\";\nimport { useSystemsDBContext, Goal, System } from \"../../../data/SystemsDB\";\nimport { useObservable } from \"../../../Utils\";\nimport { GoalView } from \"./GoalView\";\nimport { Card, IconButton, Icon, Tooltip } from \"@material-ui/core\";\nimport { SystemView } from \"./SystemView\";\nimport { ConnectionsView } from \"./ConnectionsView\";\n\nexport function SystemsPage() {\n  const db = useSystemsDBContext();\n  const scale = useObservable(() => db.getZoomLevel(), 1);\n  const goals = useObservable(() => db.getGoalsWithKey(), []);\n  const systems = useObservable(() => db.getSystemsWithKey(), []);\n  const [\n    isInCreateConnectionMode,\n    setIsInCreateConnectionMode,\n  ] = React.useState(false);\n\n  const [selectedFirstGoal, setSelectedFirstGoal] = React.useState<\n    Goal | undefined\n  >();\n\n  return (\n    <>\n      <Canvas>\n        {systems.map(([system, key]) => (\n          <SystemView key={key} system={system} scale={scale} systemKey={key} />\n        ))}\n\n        {goals.map(([goal, key]) => (\n          <GoalView\n            key={key}\n            goal={goal}\n            scale={scale}\n            onClick={(goal) => {\n              if (!isInCreateConnectionMode) return;\n              if (selectedFirstGoal == null) {\n                setSelectedFirstGoal(goal);\n              } else {\n                db.createConnection({\n                  from: selectedFirstGoal,\n                  to: goal,\n                });\n                setSelectedFirstGoal(undefined);\n                setIsInCreateConnectionMode(false);\n              }\n            }}\n            goalKey={key}\n            selectedGoal={selectedFirstGoal}\n          />\n        ))}\n        <ConnectionsView />\n      </Canvas>\n\n      <Card\n        elevation={10}\n        style={{\n          position: \"absolute\",\n          top: 70,\n          left: 20,\n          opacity: 0.7,\n          display: \"flex\",\n          flexDirection: \"column\",\n        }}\n      >\n        <Tooltip title=\"Add Goal\">\n          <IconButton\n            onClick={() => {\n              const goalName = prompt(\"Enter goal name\");\n              if (goalName == null) return;\n              const goal: Goal = {\n                labels: [],\n                name: goalName,\n                bounds: {\n                  left: -db.config.value.cameraPosition.x,\n                  top: -db.config.value.cameraPosition.y,\n                  height: 300,\n                  width: 400,\n                },\n              };\n              db.createGoal(goal);\n            }}\n          >\n            <Icon>{\"add\"}</Icon>\n          </IconButton>\n        </Tooltip>\n\n        <Tooltip title=\"Add System\">\n          <IconButton\n            onClick={() => {\n              const systemName = prompt(\"Enter system name\");\n              if (systemName == null) return;\n              const system: System = {\n                name: systemName,\n                labels: [],\n                bounds: {\n                  left: -db.config.value.cameraPosition.x,\n                  top: -db.config.value.cameraPosition.y,\n                  height: 300,\n                  width: 400,\n                },\n              };\n              db.createSystem(system);\n            }}\n          >\n            <Icon>{\"add\"}</Icon>\n          </IconButton>\n        </Tooltip>\n\n        <Tooltip title=\"Toggle Connection creation\">\n          <IconButton\n            onClick={() => {\n              if (isInCreateConnectionMode) {\n                setSelectedFirstGoal(undefined);\n                setIsInCreateConnectionMode(false);\n              } else {\n                setIsInCreateConnectionMode(true);\n              }\n            }}\n          >\n            <Icon color={isInCreateConnectionMode ? \"secondary\" : \"inherit\"}>\n              {\"trending_flat\"}\n            </Icon>\n          </IconButton>\n        </Tooltip>\n      </Card>\n    </>\n  );\n}\n","import React from \"react\";\nimport { CssBaseline, Box, Card, AppBar, Tab, Tabs } from \"@material-ui/core\";\nimport { ExchangePage } from \"./Pages/ExchangePage\";\nimport { SetupCurrencies } from \"./Pages/SetupCurrencies\";\nimport { SetupExchangeRates } from \"./Pages/SetupExchangeRates\";\nimport { PLSDBContext, CreateOrGetDefaultPLSDatabase } from \"../data/PLSDB\";\nimport { SystemsPage } from \"./Pages/Systems/SystemsPage\";\nimport { getOrAskUser } from \"../Utils\";\nimport {\n  CreateOrGetDefaultSystemsDatabase,\n  SystemsDBContext,\n} from \"../data/SystemsDB\";\nconst firebase = (window as any).firebase;\n\nfunction App() {\n  const [page, setPage] = React.useState(1);\n  const plsDb = React.useMemo(() => CreateOrGetDefaultPLSDatabase(), []);\n  const systemsDb = React.useMemo(\n    () => CreateOrGetDefaultSystemsDatabase(),\n    []\n  );\n  React.useEffect(() => {\n    const username = getOrAskUser(\"username\");\n    const password = getOrAskUser(\"password\");\n    console.log(plsDb);\n    console.log(systemsDb);\n    let didSetupDb = false;\n    const localUID = localStorage.getItem(\"uid\");\n    const setupIfNeeded = (uid: string) => {\n      if (didSetupDb) return;\n      didSetupDb = true;\n\n      plsDb.loadFromFirebase(uid);\n      systemsDb.loadFromFirebase(uid);\n    };\n    if (localUID != null) setupIfNeeded(localUID);\n    firebase\n      .auth()\n      .signInWithEmailAndPassword(username, password)\n      .then((r) => {\n        localStorage.setItem(\"uid\", r.user.uid);\n        setupIfNeeded(r.user.uid);\n      })\n      .catch((e) => {\n        alert(e.message);\n        if (localUID == null) window.location.reload();\n        else setupIfNeeded(localUID)\n      });\n  }, [plsDb, systemsDb]);\n  return (\n    <PLSDBContext.Provider value={plsDb}>\n      <SystemsDBContext.Provider value={systemsDb}>\n        <CssBaseline />\n        <AppBar position=\"static\">\n          <Tabs value={page} onChange={(_, x) => setPage(x)} centered>\n            <Tab label=\"Setup Currencies\" />\n            <Tab label=\"Exchange\" />\n            <Tab label=\"Setup Exchange Rates\" />\n            <Tab label=\"Systems\" />\n          </Tabs>\n        </AppBar>\n        {page === 3 && <SystemsPage />}\n        {page !== 3 && (\n          <Box marginTop={5} flex={1} minWidth={\"75%\"}>\n            <Card>\n              {page === 0 && <SetupCurrencies />}\n              {page === 1 && <ExchangePage />}\n              {page === 2 && <SetupExchangeRates />}\n            </Card>\n          </Box>\n        )}\n      </SystemsDBContext.Provider>\n    </PLSDBContext.Provider>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      process.env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' }\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport App from \"./Components/App\";\nimport * as serviceWorker from \"./serviceWorker\";\n\nReactDOM.render(<App />, document.getElementById(\"root\"));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}